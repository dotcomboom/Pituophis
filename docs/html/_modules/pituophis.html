<!DOCTYPE html>
<!--[if IE 8]>
<html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">

    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>pituophis &mdash; Pituophis documentation</title>


    <link href="../_static/css/theme.css" rel="stylesheet" type="text/css"/>
    <link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="../genindex.html" rel="index" title="Index"/>
    <link href="../search.html" rel="search" title="Search"/>


    <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">


<div class="wy-grid-for-nav">


    <nav class="wy-nav-side" data-toggle="wy-nav-shift">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search">


                <a class="icon icon-home" href="../index.html"> Pituophis


                </a>


                <div role="search">
                    <form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
                        <input name="q" placeholder="Search docs" type="text"/>
                        <input name="check_keywords" type="hidden" value="yes"/>
                        <input name="area" type="hidden" value="default"/>
                    </form>
                </div>


            </div>

            <div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">


                <!-- Local TOC -->
                <div class="local-toc"></div>


            </div>
        </div>
    </nav>

    <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">


        <nav aria-label="top navigation" class="wy-nav-top">

            <i class="fa fa-bars" data-toggle="wy-nav-top"></i>
            <a href="../index.html">Pituophis</a>

        </nav>


        <div class="wy-nav-content">

            <div class="rst-content">


                <div aria-label="breadcrumbs navigation" role="navigation">

                    <ul class="wy-breadcrumbs">

                        <li><a href="../index.html">Docs</a> &raquo;</li>

                        <li><a href="index.html">Module code</a> &raquo;</li>

                        <li>pituophis</li>


                        <li class="wy-breadcrumbs-aside">

                        </li>

                    </ul>


                    <hr/>
                </div>
                <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
                    <div itemprop="articleBody">

                        <h1>Source code for pituophis</h1>
                        <div class="highlight"><pre>
<span></span><span class="c1"># BSD 2-Clause License</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2019, dotcomboom &lt;dotcomboom@protonmail.com&gt; and contributors</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#   List of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#   this List of conditions and the following disclaimer in the documentation</span>
<span class="c1">#   and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="c1"># FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="c1"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="c1"># SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="c1"># OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="c1"># Portions copyright solderpunk &amp; VF-1 contributors, licensed under the BSD 2-Clause License above.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>


<span class="c1"># Quick note:</span>
<span class="c1"># selectors and item types are actually *not* sent to the server, just the path of the resource</span>


<div class="viewcode-block" id="Response"><a class="viewcode-back"
                                             href="../index.html#pituophis.Response">[docs]</a><span
        class="k">class</span> <span class="nc">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Client.* Returned by Request.get() and get(). Represents a received binary object from a Gopher server.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a BufferedReader to the object&#39;s binary property and initializes a new Response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span
            class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The data received from the server as a Bytes binary object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Response.text"><a class="viewcode-back" href="../index.html#pituophis.Response.text">[docs]</a>    <span
        class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the binary decoded as a UTF-8 String.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">binary</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span
            class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Response.menu"><a class="viewcode-back" href="../index.html#pituophis.Response.menu">[docs]</a>    <span
        class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes the binary as text and parses it as a Gopher menu. Returns a List of Gopher menu items parsed as the Selector type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parse_menu</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span
            class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span
            class="p">))</span></div></div>


<div class="viewcode-block" id="Request"><a class="viewcode-back" href="../index.html#pituophis.Request">[docs]</a><span
        class="k">class</span> <span class="nc">Request</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Client/Server.* Represents a request to be sent to a Gopher server, or received from a client.</span>

<span class="sd">    The type property is not used when sending or receiving requests; it&#39;s purely for client-side usage.</span>
<span class="sd">    The tls_verify property determines if the client will trust a self-signed certificate when using TLS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="n">host</span><span class="o">=</span><span
            class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span
            class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">path</span><span
            class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span
            class="n">query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span
            class="p">,</span> <span class="n">itype</span><span class="o">=</span><span
            class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="n">tls</span><span
            class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
            class="n">tls_verify</span><span class="o">=</span><span class="kc">True</span><span
            class="p">,</span> <span class="n">client</span><span class="o">=</span><span
            class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new Request object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client/Server.* The hostname of the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span
            class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client/Server.* The port of the server. For regular Gopher servers, this is most commonly 70, </span>
<span class="sd">        and for S/Gopher servers it is typically 105.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client/Server.* Path on the target server to request, or being requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span
            class="n">tls</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client.* Whether the target server is an S/Gopher server with TLS enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client/Server.* Search query for the server to process. Omitted when blank.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">itype</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client.* Item type of the request. Purely for client-side usage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span
            class="n">tls</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client.* Whether the request is to be sent to an S/Gopher server over TLS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls_verify</span> <span
            class="o">=</span> <span class="n">tls_verify</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Client.* Whether to verify the certificate sent from the server, rejecting self-signed and invalid certificates.</span>
<span class="sd">        ***Currently stuck on True in some functions.***</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>  <span
            class="c1"># only used in server</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *Server.* The IP address of the connected client.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Request.get"><a class="viewcode-back"
                                                href="../index.html#pituophis.Request.get">[docs]</a>    <span
        class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the Request and returns a Response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span
            class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span
            class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span
            class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span
            class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span
            class="o">.</span><span class="n">_create_unverified_context</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">tls_verify</span><span class="p">:</span>  <span class="c1"># TODO: for some reason this is always true when using the get() shorthand</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span
            class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span
            class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span
            class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span
            class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span
            class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span
            class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span
            class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">port</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span
            class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span
            class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span
            class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span
            class="n">s</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span
            class="s1">&#39;rb&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Request.url"><a class="viewcode-back"
                                                href="../index.html#pituophis.Request.url">[docs]</a>    <span
        class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a URL equivalent to the Request&#39;s properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;gopher&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span
            class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;gophers&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">path</span><span
            class="o">.</span><span class="n">startswith</span><span class="p">(</span><span
            class="s1">&#39;/&#39;</span><span class="p">)):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span
            class="o">+</span> <span class="n">path</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">query</span> <span class="o">==</span> <span
            class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span
            class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="k">return</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span
            class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span
            class="p">)</span></div></div>


<div class="viewcode-block" id="Selector"><a class="viewcode-back"
                                             href="../index.html#pituophis.Selector">[docs]</a><span
        class="k">class</span> <span class="nc">Selector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Server/Client.* Represents a selector in a parsed Gopher menu.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="n">itype</span><span class="o">=</span><span
            class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">text</span><span
            class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span
            class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span
            class="p">,</span> <span class="n">host</span><span class="o">=</span><span
            class="s1">&#39;error.host&#39;</span><span class="p">,</span> <span class="n">port</span><span
            class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tls</span><span
            class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new Selector object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span
            class="n">itype</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The type of item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span
            class="n">text</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The name, or text that is displayed when the item is in a menu.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span
            class="n">path</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Where the item links to on the target server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span
            class="n">host</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The hostname of the target server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span
            class="n">port</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The port of the target server. For regular Gopher servers, this is most commonly 70, </span>
<span class="sd">        and for S/Gopher servers it is typically 105.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span
            class="n">tls</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the selector leads to an S/Gopher server with TLS enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Selector.source"><a class="viewcode-back"
                                                    href="../index.html#pituophis.Selector.source">[docs]</a>    <span
        class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a representation of what the selector looks like in a Gopher menu.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port</span> <span class="o">&lt;</span> <span
            class="mi">65535</span><span class="p">:</span>
            <span class="c1"># Add digits to display that this is a TLS selector</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span
            class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span
            class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span
            class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span
            class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span
            class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span></div></div>


<div class="viewcode-block" id="parse_menu"><a class="viewcode-back"
                                               href="../index.html#pituophis.parse_menu">[docs]</a><span
        class="k">def</span> <span class="nf">parse_menu</span><span class="p">(</span><span
        class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Client.* Parses a String as a Gopher menu. Returns a List of Selectors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parsed_menu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span
            class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span
            class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span
            class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">menu</span><span
            class="p">:</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span
            class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span
            class="n">startswith</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span
            class="p">):</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span
            class="s1">&#39;i&#39;</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span
            class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span
            class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span
            class="p">]</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span
            class="s1">&#39;/&#39;</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span
            class="s1">&#39;error.host&#39;</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span
            class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span
            class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span
            class="s1">&#39;^(.)(.*)\t(.*)\t(.*)\t(.*)&#39;</span><span class="p">,</span> <span
            class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">type</span> <span
            class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span
            class="p">]</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">text</span> <span
            class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">2</span><span
            class="p">]</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">path</span> <span
            class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">3</span><span
            class="p">]</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">host</span> <span
            class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">4</span><span
            class="p">]</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">port</span> <span
            class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">5</span><span
            class="p">]</span>
                <span class="c1"># detect TLS</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span
            class="n">selector</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span
            class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
                    <span class="n">selector</span><span class="o">.</span><span class="n">tls</span> <span
            class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># typically the port is sent as 100105</span>
                    <span class="c1"># remove first number to get at 5 digits</span>
                    <span class="n">selector</span><span class="o">.</span><span class="n">port</span> <span
            class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span
            class="p">(</span><span class="n">selector</span><span class="o">.</span><span class="n">port</span><span
            class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">parsed_menu</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">selector</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_menu</span></div>


<div class="viewcode-block" id="parse_url"><a class="viewcode-back"
                                              href="../index.html#pituophis.parse_url">[docs]</a><span
        class="k">def</span> <span class="nf">parse_url</span><span class="p">(</span><span class="n">url</span><span
        class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Client.* Parses a Gopher URL and returns an equivalent Request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span
            class="n">host</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span
            class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">70</span><span
            class="p">,</span> <span class="n">path</span><span class="o">=</span><span
            class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">query</span><span
            class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tls</span><span
            class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># condense multiple slashes to one</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span
            class="n">sub</span><span class="p">(</span><span class="sa">r</span><span
            class="s1">&#39;/+&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span
            class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="c1"># add protocol if not there</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;:/&#39;</span> <span
            class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;gopher:/&#39;</span> <span
            class="o">+</span> <span class="n">url</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="c1"># split into protocol, host &amp; port, and then the following items for the selector/path</span>
    <span class="c1"># gopher:</span>
    <span class="c1"># gopher.floodgap.com:70</span>
    <span class="c1"># gopher/</span>
    <span class="c1"># detect tls and remove protocol</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="mi">0</span><span
            class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span
            class="s1">&#39;:&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="mi">0</span><span
            class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gophers:&#39;</span><span
            class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span
            class="kc">True</span>
        <span class="n">url</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span
            class="mi">0</span><span class="p">)</span>
    <span class="c1"># set and remove host/port</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span
            class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span> <span
            class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">req</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span
            class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span
            class="o">.</span><span class="n">split</span><span class="p">(</span><span
            class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">req</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span
            class="nb">int</span><span class="p">(</span><span class="n">url</span><span class="p">[</span><span
            class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span
            class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span
            class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">req</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span
            class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">url</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span
            class="mi">0</span><span class="p">)</span>
    <span class="c1"># remove selector if it is there</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span
            class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span
            class="mi">1</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span
            class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">url</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span
            class="mi">0</span><span class="p">)</span>
    <span class="c1"># set url to path?query</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span
            class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span
            class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span
            class="n">url</span>
    <span class="c1"># split query if it is there</span>
    <span class="k">if</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span
            class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span
            class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">url</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span
            class="mi">0</span><span class="p">)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span
            class="s1">&#39;?&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">req</span></div>


<div class="viewcode-block" id="get"><a class="viewcode-back" href="../index.html#pituophis.get">[docs]</a><span
        class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">host</span><span
        class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span
        class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span
        class="n">query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span
        class="n">tls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
        class="n">tls_verify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Client.* Quickly creates and sends a Request. Returns a Response object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span
            class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span
            class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span
            class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span
            class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span
            class="n">tls</span><span class="o">=</span><span class="n">tls</span><span class="p">,</span> <span
            class="n">tls_verify</span><span class="o">=</span><span class="n">tls_verify</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">host</span> <span
            class="ow">or</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span
            class="n">host</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">parse_url</span><span
            class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span
            class="p">()</span></div>


<span class="c1"># Server stuff</span>
<div class="viewcode-block" id="parse_gophermap"><a class="viewcode-back"
                                                    href="../index.html#pituophis.parse_gophermap">[docs]</a><span
        class="k">def</span> <span class="nf">parse_gophermap</span><span class="p">(</span><span
        class="n">source</span><span class="p">,</span> <span class="n">defHost</span><span class="o">=</span><span
        class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">defPort</span><span
        class="o">=</span><span class="s1">&#39;70&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Server.* Converts a Gophermap (as a String or List) into a Gopher menu. Returns a List of lines to send.</span>
<span class="sd">    This is *not* as feature-complete as the actual Bucktooth implementation; one example being how paths</span>
<span class="sd">    are not resolved. It does, however, fill in missing selector, host, and port fields,</span>
<span class="sd">    given that the correct host and port values are passed to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTICE:</span>
    <span class="c1"># Relative links are *not* fixed with this function!</span>
    <span class="c1"># The path isn&#39;t ever touched, so this is more for convenience of making menus</span>
    <span class="c1"># (filling in the blank fields, information selectors...)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span
            class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span
            class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span
            class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">newMenu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span
            class="n">source</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
            <span class="c1"># this is not information</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span
            class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># 1Text    pictures/    host.host    port</span>
            <span class="c1">#  ^           ^           ^           ^</span>
            <span class="n">itype</span> <span class="o">=</span> <span class="n">selector</span><span
            class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span
            class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">selector</span><span class="p">[</span><span
            class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span
            class="o">+</span> <span class="n">selector</span><span class="p">[</span><span class="mi">1</span><span
            class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">defHost</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">defPort</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">selector</span><span
            class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">selector</span><span
            class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">selector</span><span
            class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">selector</span> <span class="o">=</span> <span class="p">[</span><span
            class="n">itype</span> <span class="o">+</span> <span class="n">text</span><span class="p">,</span> <span
            class="n">path</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span
            class="n">port</span><span class="p">]</span>
            <span class="n">newMenu</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span
            class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selector</span><span
            class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span> <span
            class="o">+</span> <span class="n">selector</span>
            <span class="n">newMenu</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">selector</span><span class="p">)</span>
    <span class="c1"># return &#39;\r\n&#39;.join(newMenu)</span>
    <span class="k">return</span> <span class="n">newMenu</span></div>


<div class="viewcode-block" id="encode"><a class="viewcode-back" href="../index.html#pituophis.encode">[docs]</a><span
        class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span
        class="n">str_or_lines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Server.* Encode a List of lines or Selector objects, or a String, as bytes to be sent by serve().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span
            class="n">str_or_lines</span><span class="p">)</span> <span class="o">==</span> <span
            class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span
            class="n">str_or_lines</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span
            class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span
            class="n">str_or_lines</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span
            class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span
            class="n">str_or_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span
            class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span
            class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span
            class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span
            class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span
            class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span
            class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\r\n</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span
            class="s1">&#39;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span
            class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="n">Selector</span><span
            class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span
            class="n">source</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span
            class="n">out</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span
            class="n">str_or_lines</span><span class="p">)</span> <span class="o">==</span> <span
            class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">str_or_lines</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;encode() accepts items of type String, List, or Bytes.&quot;</span><span
            class="p">)</span></div>


<div class="viewcode-block" id="handle"><a class="viewcode-back" href="../index.html#pituophis.handle">[docs]</a><span
        class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">request</span><span
        class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Server.* Default handler function for Gopher requests while hosting a server. Currently a stub.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Selector</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span
            class="s2">&quot;Path: &quot;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span
            class="n">path</span><span class="p">),</span>
        <span class="n">Selector</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span
            class="s2">&quot;Query: &quot;</span> <span class="o">+</span> <span class="n">request</span><span
            class="o">.</span><span class="n">query</span><span class="p">),</span>
        <span class="n">Selector</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span
            class="s2">&quot;Host: &quot;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span
            class="n">host</span><span class="p">),</span>
        <span class="n">Selector</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span
            class="s2">&quot;Port: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span
            class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">port</span><span
            class="p">)),</span>
        <span class="n">Selector</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span
            class="s2">&quot;Client: &quot;</span> <span class="o">+</span> <span class="n">request</span><span
            class="o">.</span><span class="n">client</span><span class="p">),</span>
        <span class="n">Selector</span><span class="p">(),</span>
        <span class="n">Selector</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span
            class="s2">&quot;This is the default Pituophis handler.&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">encode</span><span class="p">(</span><span class="n">menu</span><span
            class="p">)</span></div>


<div class="viewcode-block" id="serve"><a class="viewcode-back" href="../index.html#pituophis.serve">[docs]</a><span
        class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="n">host</span><span
        class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span
        class="n">port</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">handler</span><span
        class="o">=</span><span class="n">handle</span><span class="p">,</span> <span class="n">tls</span><span
        class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
        class="n">tlscertchainpath</span><span class="o">=</span><span class="s1">&#39;cacert.pem&#39;</span><span
        class="p">,</span>
          <span class="n">tlsprivatekeypath</span><span class="o">=</span><span
            class="s1">&#39;privkey.pem&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span
            class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Server.*  Listens for Gopher requests. Allows for using a custom handler that will return a binary (Bytes) object</span>
<span class="sd">    to send to the client. After sending them, the finishing &quot;.&quot; is sent and the connection is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span
            class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span
            class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span
            class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tls</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span
            class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span
            class="n">PROTOCOL_TLS_SERVER</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">exists</span><span class="p">(</span><span
            class="n">tlscertchainpath</span><span class="p">)</span> <span class="ow">and</span> <span
            class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span
            class="n">exists</span><span class="p">(</span><span class="n">tlsprivatekeypath</span><span
            class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span
            class="n">tlscertchainpath</span><span class="p">,</span> <span class="n">tlsprivatekeypath</span><span
            class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span
            class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span
            class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span
            class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TLS certificate and/or private key is missing. TLS has been disabled for this session.&#39;</span><span
            class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Run this command to generate a self-signed certificate and private key:&#39;</span><span
            class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;  openssl req -x509 -newkey rsa:4096 -keyout &quot;&#39;</span> <span
            class="o">+</span> <span class="n">tlsprivatekeypath</span> <span class="o">+</span> <span class="s1">&#39;&quot; -out &quot;&#39;</span> <span
            class="o">+</span> <span class="n">tlscertchainpath</span> <span class="o">+</span> <span class="s1">&#39;&quot; -days 365&#39;</span><span
            class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Note that clients might refuse to connect to a self-signed certificate.&#39;</span><span
            class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="n">tls</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span
            class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span
            class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tls</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;S/Gopher server is now running on&#39;</span><span
            class="p">,</span> <span class="n">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span
            class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gopher server is now running on&#39;</span><span
            class="p">,</span> <span class="n">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span
            class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span
            class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span
            class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span
            class="s1">&#39;Connected by&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span
            class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span
            class="p">)</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">data</span><span
            class="o">.</span><span class="n">decode</span><span class="p">(</span><span
            class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span
            class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span
            class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">request</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span
            class="p">:</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span
            class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span
            class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span
            class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span
            class="s1">&#39;Client requests:&#39;</span><span class="p">,</span> <span class="n">path</span><span
            class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">handler</span><span
            class="p">(</span><span class="n">Request</span><span class="p">(</span><span class="n">path</span><span
            class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">query</span><span
            class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">host</span><span
            class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span
            class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">client</span><span
            class="o">=</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span
            class="p">]))</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span
            class="p">(</span><span class="n">resp</span><span class="p">)</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection closed&#39;</span><span
            class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span
            class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span
            class="p">,</span> <span class="n">e</span><span class="p">)</span></div>
</pre>
                        </div>

                    </div>

                </div>
                <footer>


                    <hr/>

                    <div role="contentinfo">
                        <p>
                            &copy; Copyright 2019, dotcomboom

                        </p>
                    </div>
                    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a
                        href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a
                        href="https://readthedocs.org">Read the Docs</a>.

                </footer>

            </div>
        </div>

    </section>

</div>


<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"
        type="text/javascript"></script>
<script src="../_static/jquery.js" type="text/javascript"></script>
<script src="../_static/underscore.js" type="text/javascript"></script>
<script src="../_static/doctools.js" type="text/javascript"></script>
<script src="../_static/language_data.js" type="text/javascript"></script>


<script src="../_static/js/theme.js" type="text/javascript"></script>

<script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });

</script>

</body>
</html>